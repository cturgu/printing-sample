<html>
    <head>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css" />

	
	    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 90%;
        width: 100%;        
      }
    </style>
	<script src="https://js.arcgis.com/4.22/"></script>
  
	
       <script>
    HTMLCanvasElement.prototype.getContext = (function(origFn) {
      return function(type, attributes) {
        if (
          ["experimental-webgl", "webgl", "webkit-3d", "moz-webgl"].includes(type)
        ) {
          attributes = Object.assign({}, attributes, {
            preserveDrawingBuffer: true,
			      premultipliedAlpha: false
          });
        }
        return origFn.call(this, type, attributes);
      };
    })(HTMLCanvasElement.prototype.getContext);
  
  	require(["esri/views/MapView", "esri/WebMap"], (MapView, WebMap) => {
        const webmap = new WebMap({
          portalItem: {
            // autocasts as new PortalItem()
            id: "f2e9b762544945f390ca4ac3671cfa72"
          }
        });

        const view = new MapView({
          map: webmap,
          container: "viewDiv"
        });

        view.when(() => { 
			if(window.location.hash === "#print") {
			  setTimeout(pageready, 5000);          
			}
        });
     
    });

</script>
    </head>
<body>
  <h1>Sample Print</h1>
  <div id="viewDiv"></div>
  <div id="pageReady" style="display:none"></div>
  <img id="canvasImage" style="display:none" src="#" alt="" />
  <p>
    <button id= "btnPrint" onclick="printHandle()">Print</button>     
    <script>
      'use strict'
      function printHandle() {
        fetchRequest();           
      }

      function pageready()
      {
        document.getElementById("pageReady").innerHTML = "OK";
        preparePrint()
      }

      function preparePrint()
      {
        console.log("preParePrint() initiated.");
        hide(document.getElementById("btnPrint"));
        var canvas = document.getElementsByTagName("canvas")[0];
        var gl = canvas.getContext("webgl", {
          preserveDrawingBuffer: true
        });
        var dataString = canvas.toDataURL();
        document.getElementById('canvasImage').setAttribute('src', dataString);
        hide(document.getElementById("viewDiv"));
        show(document.getElementById('canvasImage'));
      }
      
      var show = function (elem) {
        elem.style.display = 'block';
      };

      // Hide an element
      var hide = function (elem) {
        elem.style.display = 'none';
      };

 
	function fetchRequest(){
		  console.log("CAM");

		  let xhr = new XMLHttpRequest();
		  //const urlParam = encodeURIComponent("http://localhost:8282/index.html#print")
		  const urlParam = encodeURIComponent("https://cturgu.github.io/printing-sample#print")
		  console.log(urlParam)
		  xhr.open('GET', "https://func-uksouth-geo-print-poc-qa01.azurewebsites.net/api/PuppeteerPrintingFunction?url="+urlParam, true);
		  //xhr.open('GET', "http://localhost:7071/api/PuppeteerPrintingFunction?url="+urlParam, true);
		  xhr.responseType = "blob";
		  xhr.send();
		  
		  xhr.addEventListener("readystatechange", processRequest, false);
		  function processRequest(e) {
			if (xhr.readyState == 4 && xhr.status == 200) {
				 //var blob = new Blob([xhr.response], { type: 'application/pdf' }),
				 var link=document.createElement('a');
				 link.href=window.URL.createObjectURL(xhr.response);
				 link.download='print.pdf';
				 link.click();
			}
		}
	}
    </script>
</body>
</html>